<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Widget Energym Demo</title>
  <style>
    #chat-widget-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 350px;
      z-index: 9999;
      font-family: Arial, sans-serif;
    }
    #chat-widget-window {
      display: none;
      flex-direction: column;
      height: 500px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 10px;
      overflow: hidden;
    }
    #chat-widget-header {
      background: #27ae60;
      color: #fff;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chat-widget-title { font-weight: bold; }
    #chat-widget-close { cursor: pointer; }
    #chat-widget-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    .chat-message {
      max-width: 80%;
      padding: 10px 15px;
      margin-bottom: 10px;
      border-radius: 18px;
      word-wrap: break-word;
    }
    .user-message {
      align-self: flex-end;
      background: #27ae60;
      color: #fff;
      border-bottom-right-radius: 5px;
    }
    .bot-message {
      align-self: flex-start;
      background: #e8f0fe;
      color: #333;
      border-bottom-left-radius: 5px;
    }
    #chat-widget-input-container {
      display: flex;
      padding: 10px;
      border-top: 1px solid #eee;
      background: #fff;
    }
    #chat-widget-input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
      font-size: 14px;
    }
    #chat-widget-audio {
      margin-left: 5px;
    }
    #chat-widget-send {
      width: 40px;
      height: 40px;
      margin-left: 10px;
      border-radius: 50%;
      background: #27ae60;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    #chat-widget-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #27ae60;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      align-self: flex-end;
      font-size: 24px;
    }
    #chat-widget-audio-label {
      margin-left: 5px;
      font-size: 12px;
      color: #888;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .audio-selected {
      color: #27ae60 !important;
      font-weight: bold;
    }
    .audio-loading {
      color: #f39c12 !important;
      animation: pulse 1.5s infinite;
    }
    .audio-sent {
      color: #27ae60 !important;
      opacity: 0.7;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .audio-status {
      display: inline-block;
      margin-left: 5px;
      font-size: 12px;
    }
    .audio-status.loading {
      color: #f39c12;
    }
    .audio-status.success {
      color: #27ae60;
    }
    .audio-status.error {
      color: #e74c3c;
    }
  </style>
</head>
<body>
  <div id="chat-widget-container">
    <div id="chat-widget-window">
      <div id="chat-widget-header">
        <span id="chat-widget-title">Energym Asistente</span>
        <span id="chat-widget-close">&times;</span>
      </div>
      <div id="chat-widget-messages"></div>
      <div id="chat-widget-input-container">
        <input type="text" id="chat-widget-input" placeholder="Escribe un mensaje...">
        <input type="file" id="chat-widget-audio" accept="audio/*" style="margin-left:5px;">
        <span id="chat-widget-audio-label" style="margin-left:5px;font-size:12px;color:#888;"></span>
        <div id="chat-widget-send">&#9658;</div>
      </div>
    </div>
    <div id="chat-widget-button">&#128172;</div>
  </div>
  <script>
    const widgetConfig = {
      apiUrl: 'https://chat-aggregator-backend-v2.onrender.com/webhook',
      title: 'Energym Asistente',
      primaryColor: '#27ae60',
      welcomeMessage: '¡Hola! Soy el asistente de Energym, ¿en qué puedo ayudarte?'
    };

    // Elementos del DOM
    const chatButton = document.getElementById('chat-widget-button');
    const chatWindow = document.getElementById('chat-widget-window');
    const chatClose = document.getElementById('chat-widget-close');
    const chatMessages = document.getElementById('chat-widget-messages');
    const chatInput = document.getElementById('chat-widget-input');
    const chatSend = document.getElementById('chat-widget-send');
    const chatTitle = document.getElementById('chat-widget-title');

    // Personalización
    chatTitle.textContent = widgetConfig.title;
    chatButton.style.background = widgetConfig.primaryColor;
    chatWindow.querySelector('#chat-widget-header').style.background = widgetConfig.primaryColor;
    chatSend.style.background = widgetConfig.primaryColor;

    // Mostrar mensaje de bienvenida
    function addBotMessage(message, type = 'info') {
      const msg = document.createElement('div');
      msg.className = 'chat-message bot-message';
      
      if (type === 'loading') {
        const loadingIcon = document.createElement('span');
        loadingIcon.textContent = '⏳ ';
        msg.appendChild(loadingIcon);
      } else if (type === 'success') {
        const successIcon = document.createElement('span');
        successIcon.textContent = '✅ ';
        msg.appendChild(successIcon);
      } else if (type === 'error') {
        const errorIcon = document.createElement('span');
        errorIcon.textContent = '❌ ';
        msg.appendChild(errorIcon);
      }
      
      const textNode = document.createTextNode(message);
      msg.appendChild(textNode);
      
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function addUserMessage(message, isAudio = false) {
      const msg = document.createElement('div');
      msg.className = 'chat-message user-message';
      
      if (isAudio) {
        const audioIcon = document.createElement('span');
        audioIcon.textContent = '🎵 ';
        msg.appendChild(audioIcon);
      }
      
      const textNode = document.createTextNode(message);
      msg.appendChild(textNode);
      
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Abrir/cerrar chat
    chatButton.onclick = () => {
      chatWindow.style.display = 'flex';
      chatButton.style.display = 'none';
    };
    chatClose.onclick = () => {
      chatWindow.style.display = 'none';
      chatButton.style.display = 'flex';
    };

    // Enviar mensaje
    chatSend.onclick = sendMessage;
    chatInput.onkeypress = function(e) {
      if (e.key === 'Enter') sendMessage();
    };

    // Mostrar nombre del archivo de audio seleccionado
    const audioInput = document.getElementById('chat-widget-audio');
    const audioLabel = document.getElementById('chat-widget-audio-label');
    audioInput.onchange = function() {
      if (audioInput.files.length > 0) {
        audioLabel.textContent = audioInput.files[0].name;
        audioLabel.classList.add('audio-selected');
      } else {
        audioLabel.textContent = '';
        audioLabel.classList.remove('audio-selected');
      }
    };

    // Generar o recuperar user_id persistente
    let userId = localStorage.getItem('chat_widget_user_id');
    if (!userId) {
      userId = 'user_' + Math.random().toString(36).substring(2, 15);
      localStorage.setItem('chat_widget_user_id', userId);
    }

    function sendMessage() {
      const message = chatInput.value.trim();
      const audioFile = audioInput.files[0];
      
      // Si no hay mensaje ni audio, no hacer nada
      if (!message && !audioFile) return;
      
      // Mostrar mensaje del usuario
      if (message) {
        addUserMessage(message);
        // Mostrar 'escribiendo...' como mensaje del bot
        addBotMessage('escribiendo...', 'loading');
      }
      
      // Limpiar input de texto
      chatInput.value = '';
      
      // Enviar texto si existe
      if (message) {
        fetch(widgetConfig.apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: userId,
            channel: 'web',
            type: 'text',
            payload: { text: message }
          })
        })
        .then(res => res.text())
        .then(text => {
          // Eliminar el último mensaje 'escribiendo...'
          const botMsgs = chatMessages.querySelectorAll('.bot-message');
          if (botMsgs.length > 0) {
            const lastBot = botMsgs[botMsgs.length - 1];
            if (lastBot.textContent.includes('escribiendo')) {
              lastBot.remove();
            }
          }
          // Mostrar solo un check tipo WhatsApp
          addBotMessage('✔️', 'success');
          // Si hay texto de respuesta, mostrarlo como mensaje del bot
          if (text && text.trim().length > 0) {
            addBotMessage(text.trim(), 'info');
          }
        })
        .catch(() => {
          // Eliminar 'escribiendo...' si hay error
          const botMsgs = chatMessages.querySelectorAll('.bot-message');
          if (botMsgs.length > 0) {
            const lastBot = botMsgs[botMsgs.length - 1];
            if (lastBot.textContent.includes('escribiendo')) {
              lastBot.remove();
            }
          }
          addBotMessage('No se pudo conectar con el servidor.', 'error');
        });
      }
      
      // Enviar audio si existe
      if (audioFile) {
        const formData = new FormData();
        formData.append('user_id', userId);
        formData.append('channel', 'web');
        formData.append('type', 'audio');
        formData.append('audio', audioFile);
        
        // Mostrar feedback visual de envío
        addUserMessage('Enviando audio: ' + audioFile.name, true);
        addBotMessage('Procesando audio...', 'loading');
        
        // Actualizar estado visual del label
        audioLabel.classList.remove('audio-selected');
        audioLabel.classList.add('audio-loading');
        audioLabel.textContent = 'Enviando...';
        
        fetch(widgetConfig.apiUrl, {
          method: 'POST',
          body: formData
        })
        .then(res => res.text())
        .then(text => {
          // Eliminar el último mensaje 'Procesando audio...'
          const botMsgs = chatMessages.querySelectorAll('.bot-message');
          if (botMsgs.length > 0) {
            const lastBot = botMsgs[botMsgs.length - 1];
            if (lastBot.textContent.includes('Procesando audio')) {
              lastBot.remove();
            }
          }
          // Mostrar solo un check tipo WhatsApp
          addBotMessage('✔️', 'success');
          // Si hay texto de respuesta, mostrarlo como mensaje del bot
          if (text && text.trim().length > 0) {
            addBotMessage(text.trim(), 'info');
          }
        })
        .catch(() => {
          // Eliminar 'Procesando audio...' si hay error
          const botMsgs = chatMessages.querySelectorAll('.bot-message');
          if (botMsgs.length > 0) {
            const lastBot = botMsgs[botMsgs.length - 1];
            if (lastBot.textContent.includes('Procesando audio')) {
              lastBot.remove();
            }
          }
          addBotMessage('No se pudo conectar con el servidor.', 'error');
        })
        .finally(() => {
          // Limpiar input de audio y estados visuales
          audioInput.value = '';
          audioLabel.textContent = '';
          audioLabel.classList.remove('audio-loading');
        });
      }

      // Después de enviar el mensaje al backend, si la respuesta incluye use_sse y sse_endpoint, abrir una conexión SSE y mostrar la respuesta en tiempo real.
      // Agregar la lógica de conexión SSE y manejo de eventos en el frontend, similar a widget-sse.html.
    }

    // Inicializar
    addBotMessage(widgetConfig.welcomeMessage);
  </script>
</body>
</html> 